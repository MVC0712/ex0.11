<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packing Box List</title>
    <link rel="stylesheet" href="./css/main.css" />
    <link rel="stylesheet" href="./css/PackingBoxList.css" />
  </head>

  <body>
    <header>Packing Box List</header>
    <div class="input__wrapper">
      <div class="input-block__outer">
        <div class="input__title">Box Number</div>
        <input id="box-number__input" class="need-clear no-input" type="text" />
        <button id="add__button" disabled>Add</button>
      </div>
    </div>
    <div class="summary__wrapper">
      <table id="summary__table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Box Number</th>
            <th>Production Number</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script src="./lib/jquery-3.3.1.min.js"></script>
    <script>
      let ajaxReturnData;
      const myAjax = {
        myAjax: function (fileName, sendData) {
          $.ajax({
            type: "POST",
            url: fileName,
            dataType: "json",
            data: sendData,
            async: false,
          })
            .done(function (data) {
              ajaxReturnData = data;
            })
            .fail(function () {
              alert("DB connect error");
            });
        },
      };
      $(function () {
        makeSummaryTable();
      });

      $(document).on("click", "table tr", function (e) {
        let id_name;
        id_name = $(this).parent().parent().attr("id");
        id_name = id_name + "_selected__tr";
        if (!$(this).hasClass("selected-record")) {
          // tr に class を付与し、選択状態の background colorを付ける
          $(this).parent().find("tr").removeClass("selected-record");
          $(this).parent().find("input").removeClass("selected-input");
          $(this).addClass("selected-record");
          $(this).find("input").addClass("selected-input");
          // tr に id を付与する
          $("#" + id_name).removeAttr("id");
          $(this).attr("id", id_name);
        } else {
          // click again same record, move selected data to parent window
          let boxNumberId = $(this).find("td").eq(0).html();
          let boxNumber = $(this).find("input").val();
          $(window.opener.document)
            .find("#box-number__select")
            .empty()
            .append($("<option>").val("0").html("no"))
            .append($("<option>").val(boxNumberId).html(boxNumber));
          open("about:blank", "_self").close(); // ウィンドウを閉じる
        }
      });

      $(document).on("keyup", "#box-number__input", function (e) {
        $(this).val($(this).val().toUpperCase()); // 小文字を大文字に
        if ($(this).val().length >= 5 && $(this).val() != "") {
          $(this).removeClass("no-input").addClass("complete-input");
          $("#add__button").prop("disabled", false);
        } else {
          $(this).removeClass("complete-input").addClass("no-input");
          $("#add__button").prop("disabled", true);
        }
      });

      $(document).on("click", "#add__button", function (e) {
        let fileName;
        let sendData = new Object();
        fileName = "./php/Packing/InsBoxNumber.php";
        sendData = {
          dummy: "dummy",
          box_number: $("#box-number__input").val(),
          created_at: getToday(),
        };
        myAjax.myAjax(fileName, sendData);
        // ==== remake summary table  ============
        makeSummaryTable();
        $("#box-number__input")
          .val("")
          .removeClass("complete-input")
          .addClass("no-input");
        $("#add__button").prop("disabled", true);
      });

      function makeSummaryTable() {
        let fileName;
        let sendData = new Object();
        fileName = "./php/Packing/SelBoxNumber.php";
        sendData = {
          limit: 100,
        };
        myAjax.myAjax(fileName, sendData);
        $("#summary__table tbody").empty();
        ajaxReturnData.forEach(function (trVal) {
          var newTr = $("<tr>");
          Object.keys(trVal).forEach(function (tdVal, index) {
            if (index == 1) {
              $("<td>").append($("<input>").val(trVal[tdVal])).appendTo(newTr);
            } else {
              $("<td>").html(trVal[tdVal]).appendTo(newTr);
            }
          });
          $(newTr).appendTo("#summary__table tbody");
        });
      }

      function getToday() {
        // 本日の日付をyy-mm-dd形式で返す
        let dt = new Date();
        return (
          dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate()
        );
      }
    </script>
  </body>
</html>
